<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:skia="clr-namespace:SkiaSharp.Extended.UI.Controls;assembly=SkiaSharp.Extended.UI"
             x:Class="NeuroMate.Views.LootBoxPage"
             Shell.NavBarIsVisible="False"
             BackgroundColor="{StaticResource PageBackground}">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Header -->
        <Frame Grid.Row="0" Style="{StaticResource ElevatedCard}" 
               Margin="16,24,16,12"
               Background="{StaticResource CardGradient}">
            <Grid ColumnSpacing="16">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Powrót -->
                <Button Grid.Column="0" 
                        Text="←" 
                        Style="{StaticResource CircleButton}"
                        WidthRequest="50" HeightRequest="50"
                        Clicked="OnBackClicked" />

                <!-- Informacje -->
                <StackLayout Grid.Column="1" VerticalOptions="Center" Spacing="4">
                    <Label Text="📦 Skrzynki Skarbów" 
                           Style="{StaticResource TitleStyle}" 
                           FontSize="22" />
                    <Label x:Name="PointsLabel"
                           Text="💎 Punkty: 0"
                           Style="{StaticResource SubtitleStyle}"
                           FontSize="16" />
                </StackLayout>

                <!-- Statystyki -->
                <StackLayout Grid.Column="2" VerticalOptions="Center">
                    <Label x:Name="BoxesOpenedLabel"
                           Text="Otwarto: 0"
                           Style="{StaticResource Subtitle}"
                           FontSize="12"
                           HorizontalTextAlignment="Center" />
                </StackLayout>
            </Grid>
        </Frame>

        <!-- Main Content -->
        <ScrollView Grid.Row="1">
            <StackLayout Spacing="20" Margin="16">

                <!-- Dostępne lootboxy -->
                <CollectionView x:Name="LootBoxesCollection"
                                ItemsLayout="VerticalList"
                                VerticalScrollBarVisibility="Never">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame Style="{StaticResource CardFrame}" Margin="0,8">
                                <Grid ColumnSpacing="15" RowSpacing="10">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="80" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <!-- Ikona lootboxa -->
                                    <Frame Grid.RowSpan="3" Grid.Column="0" 
                                           Style="{StaticResource AvatarFrame}"
                                           WidthRequest="70" HeightRequest="70">
                                        <Image Source="{Binding IconPath}"
                                               WidthRequest="50" HeightRequest="50" />
                                    </Frame>

                                    <!-- Nazwa i opis -->
                                    <Label Grid.Row="0" Grid.Column="1" 
                                           Text="{Binding Name}"
                                           Style="{StaticResource SectionTitle}"
                                           FontSize="18" />
                                    
                                    <Label Grid.Row="1" Grid.Column="1" 
                                           Text="{Binding Description}"
                                           Style="{StaticResource Subtitle}"
                                           FontSize="14" />

                                    <!-- Szanse drop -->
                                    <Label Grid.Row="2" Grid.Column="1" 
                                           Text="{Binding DropRatesText}"
                                           Style="{StaticResource Subtitle}"
                                           FontSize="12"
                                           TextColor="{StaticResource Gray600}" />

                                    <!-- Cena i przycisk -->
                                    <StackLayout Grid.RowSpan="3" Grid.Column="2" 
                                               VerticalOptions="Center" Spacing="8">
                                        <Label Text="{Binding PriceText}"
                                               Style="{StaticResource SectionTitle}"
                                               FontSize="16"
                                               HorizontalTextAlignment="Center" />
                                        
                                        <Button Text="Otwórz"
                                                Style="{Binding ButtonStyle}"
                                                Clicked="OnOpenLootBoxClicked"
                                                CommandParameter="{Binding Id}"
                                                IsEnabled="{Binding CanAfford}" />
                                    </StackLayout>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

            </StackLayout>
        </ScrollView>

        <!-- Animacja otwierania lootboxa (overlay) -->
        <Grid x:Name="OpeningOverlay" Grid.RowSpan="2" 
              BackgroundColor="#AA000000" 
              IsVisible="False">
            
            <StackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="30">
                
                <!-- Animacja otwierania -->
                <Frame Style="{StaticResource AvatarFrame}" 
                       WidthRequest="150" HeightRequest="150"
                       BackgroundColor="Transparent"
                       BorderColor="Gold"
                       HasShadow="True">
                    <skia:SKLottieView x:Name="OpeningAnimation"
                                       Source="box_opening.json"
                                       RepeatCount="1"
                                       IsAnimationEnabled="False"
                                       WidthRequest="130"
                                       HeightRequest="130" />
                </Frame>

                <!-- Tekst otwierania -->
                <Label x:Name="OpeningLabel"
                       Text="Otwieranie skrzynki..."
                       Style="{StaticResource TitleStyle}"
                       FontSize="24"
                       TextColor="White"
                       HorizontalTextAlignment="Center" />

            </StackLayout>
        </Grid>

        <!-- Wynik otwarcia (overlay) -->
        <Grid x:Name="ResultOverlay" Grid.RowSpan="2" 
              BackgroundColor="#AA000000" 
              IsVisible="False">
            
            <Frame Style="{StaticResource ElevatedCard}" 
                   Margin="30" 
                   Padding="30"
                   VerticalOptions="Center">
                
                <StackLayout Spacing="20">
                    
                    <!-- Wynik header -->
                    <Label x:Name="ResultHeaderLabel"
                           Text="🎉 Gratulacje!"
                           Style="{StaticResource TitleStyle}"
                           FontSize="26"
                           HorizontalTextAlignment="Center" />

                    <!-- Zdobyty awatar -->
                    <Frame Style="{StaticResource AvatarFrame}" 
                           WidthRequest="100" HeightRequest="100"
                           HorizontalOptions="Center">
                        <skia:SKLottieView x:Name="RewardAvatarLottie"
                                           RepeatCount="-1"
                                           IsAnimationEnabled="True"
                                           WidthRequest="80"
                                           HeightRequest="80" />
                    </Frame>

                    <!-- Informacje o nagrodzie -->
                    <StackLayout Spacing="10">
                        <Label x:Name="RewardNameLabel"
                               Style="{StaticResource SectionTitle}"
                               FontSize="20"
                               HorizontalTextAlignment="Center" />
                        
                        <Label x:Name="RewardDescriptionLabel"
                               Style="{StaticResource Subtitle}"
                               FontSize="14"
                               HorizontalTextAlignment="Center" />

                        <Label x:Name="RewardStatusLabel"
                               Style="{StaticResource Subtitle}"
                               FontSize="16"
                               FontAttributes="Bold"
                               HorizontalTextAlignment="Center" />
                    </StackLayout>

                    <!-- Przyciski -->
                    <StackLayout Orientation="Horizontal" 
                               HorizontalOptions="Center" 
                               Spacing="15">
                        <Button Text="Kontynuuj"
                                Style="{StaticResource PrimaryButton}"
                                Clicked="OnContinueClicked" />
                        
                        <Button Text="Przejdź do sklepu"
                                Style="{StaticResource SecondaryButton}"
                                Clicked="OnGoToShopClicked" />
                    </StackLayout>

                </StackLayout>
            </Frame>
        </Grid>

        <!-- Loading indicator -->
        <ActivityIndicator x:Name="LoadingIndicator" 
                           Grid.Row="1"
                           IsVisible="False"
                           IsRunning="False"
                           Color="{StaticResource Primary}" />
    </Grid>
</ContentPage>
